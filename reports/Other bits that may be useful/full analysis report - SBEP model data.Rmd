---
title: "SBEP Data Report"
author: "2509920F"
date: "XXXXXXX"
output:
  bookdown::word_document2: 
    fig_caption: yes
    reference_docx: SBEP_Template.docx
  word_document:
    fig_caption: yes
    reference_docx: SBEP_Template.docx
  pdf_document: default
  html_document:  
    df_print: paged
csl: C:/Users/alexf/OneDrive - University of Glasgow/non-dclin/R library/csl/sage-harvard.csl
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE)
require("knitr")
opts_knit$set(root.dir = "..") #  I put this in to raise up the working directory from the reports folder (where the rmd lives) to one level above 

```


```{r launch_scripts, echo=FALSE, results=FALSE, message=FALSE, fig.show='hide'}
source("./scripts/SBEP_patient_script_2_q2.R")
```


# Executive Summary


# Analysis Methods

## Analysis of patient data
Analysis began with access to patient data from both an existing electronic database and supplementary information from casefiles. Data was loaded into the statistical program environment R Studio for initial examination and cleaning.The initial dataset included data for all patients screened, and those who were deemed unsuitable for psychological therapies were excluded from analysis. This filtered dataset contained no further missing data and was the basis for the subsequent analyses. The data was cleaned and pre-processed (checking variable names and types, creating new variables such as waiting times in weeks from the day data) before conducting the analyses described below.

### Visualisation approaches
For comparing proportions between Time point 1 and 2 ( as per Audit Question 1a, 2a, 2b) this report uses proportional stacked bar graphs, also called 100% stacked bar graphs. This is a simple visual way to show proportion information, eliminating the trickiness of comparing 'like for like' when numbers may be different.

```{r stackedexample, echo=FALSE, eval=FALSE}

snack <- c('chocolate','chocolate','chocolate','chocolate','chocolate', 'chocolate',
             'chocolate','chocolate','chocolate','chocolate','apple','apple', 'apple', 'apple', 'apple')
bloated <- c('no','yes','no','yes','no','yes','no','yes','no','yes','yes','yes','no','no','no')
people <- 1:60

example <- data.frame(people,snack,bloated, stringsAsFactors = TRUE)

exampleplot1 <- example %>%
  # note we are dropping the NAs
  drop_na(snack) %>%
  ggplot(mapping = aes(x=snack, fill=bloated)) + geom_bar()


exampleplot2 <- example %>%
  # note we are dropping the NAs
  drop_na(snack) %>%
  ggplot(mapping = aes(x=snack, fill=bloated,label = paste(round((..count..)/sum(..count..)*100), "%"))) + geom_bar(position="fill") + ylab("proportion")

ggarrange(exampleplot1 + rremove("legend"), exampleplot2, 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)


```


# Results

The below table shows the overall demographics of all patients seen within the time of the audit.

```{r demographic_table}

demographics <- print_2x2_kable_table(data = ap_patients,
                      x = agebound,
                      y = Gender,
                      x_name = "Age band",
                      y_name = "Gender",
                      caption = "Patient demographics"
                      )
demographics

```

## Audit Q1a
### Is there a difference  between T1 and T2 with regard to the proportion of patients who are offered treatment within 18 weeks of referral?

```{r summary_table}

basicdata <- ap_patients %>%
  select(RTT_week, Sessions_attended, Group)

attr(basicdata$Group, 'label') <- "Time Period"


basicsummaries <- basicdata %>%
  group_by(Group) %>%
  summarise(
    count=n(),
    
    median_weeks_waiting = median(RTT_week,na.rm=TRUE),
    lower_quartile_waiting = round(median_weeks_waiting - IQR(RTT_week,na.rm=TRUE), digits = 0),
    higher_quartile_waiting = round(median_weeks_waiting + IQR(RTT_week,na.rm=TRUE), digits = 0),
    sessions = round(median(Sessions_attended,na.rm=TRUE), digits = 1)
  ) 
# Note the double brackets - to extract as a value rather than as a tibble
pre_median_weeks <- basicsummaries[[1,3]]
post_median_weeks <- basicsummaries[[2,3]]


my_controls <- tableby.control(
  #test = T,
  #total = T,
  #numeric.test = "kwt", cat.test = "chisq",
  numeric.stats = c("meansd", "medianq1q3", "range", "Nmiss2"),
  cat.stats = c("countpct", "Nmiss2"),
  stats.labels = list(
    meansd = "Mean (SD)",
    medianq1q3 = "Median (Q1, Q3)",
    range = "Min - Max",
    Nmiss2 = "Missing"
  )
)
 
 
my_labels <- list(
  RTT_week = "Waiting time (weeks)",
  Sessions_attended = "Number of sessions attended"
)

demosum2 <-tableby(Group ~., data = basicdata, control = my_controls)
```


``` {r makingtable}

test<-summary(demosum2, 
               digits = 2,
        labelTranslations = my_labels,
        title ="THIS IS MY TITLE PLEASE", text = TRUE, results = "asis", pfootnote=TRUE
        )
```


``` {r another_table}
knitr::kable(test, booktabs = TRUE, caption = "This is definitely definitely my title now")

```

If you look at \@ref(tab:another_table) above, you will see


``` {r pander_table}
pandoc.table(basicdata[1:2,1:3], style = "simple")

```



## In text stuff
The average number of days people waited before the service change was `r pre_median_weeks` and then afterward `r post_median_weeks`



```{r week_count_table, eval = FALSE}

ap_patients %>%
  mutate(weekit = round(RTT_week)) %>%
 count(weekit)  %>%
arrange(desc(n))


```

  )



# Discussion
